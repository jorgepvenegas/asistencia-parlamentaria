---
import { BarChart, Bar, XAxis, YAxis, CartesianGrid, Tooltip, Legend, ResponsiveContainer, Cell } from 'recharts';

interface Props {
  data: Array<{
    name: string;
    attended: number;
    unattended: number;
    excused: number;
    percentage?: number;
  }>;
  title?: string;
  color?: string;
}

const { data, title = 'Attendance Distribution', color = '#22c55e' } = Astro.props;

// Colors for each attendance status
const colors = {
  attended: '#22c55e',    // Green
  unattended: '#ef4444',  // Red
  excused: '#f59e0b',     // Amber
};

const chartData = data.map(item => ({
  ...item,
  total: item.attended + item.unattended + item.excused,
}));
---

<div class="w-full h-full bg-white rounded-lg shadow-sm border border-gray-200 p-6">
  {title && <h2 class="text-lg font-semibold mb-4 text-gray-900">{title}</h2>}

  <div class="w-full h-96">
    <ResponsiveContainer width="100%" height="100%">
      <BarChart
        data={chartData}
        margin={{ top: 20, right: 30, left: 0, bottom: 20 }}
        role="img"
        aria-label={`${title} - Attendance stacked bar chart`}
      >
        <CartesianGrid strokeDasharray="3 3" stroke="#e5e7eb" />
        <XAxis
          dataKey="name"
          tick={{ fontSize: 12 }}
          angle={-45}
          textAnchor="end"
          height={80}
        />
        <YAxis
          label={{ value: 'Sessions', angle: -90, position: 'insideLeft' }}
          tick={{ fontSize: 12 }}
        />
        <Tooltip
          contentStyle={{
            backgroundColor: '#fff',
            border: '1px solid #e5e7eb',
            borderRadius: '0.5rem',
          }}
          formatter={(value) => {
            if (typeof value === 'number') {
              return `${value} sessions`;
            }
            return value;
          }}
        />
        <Legend
          wrapperStyle={{ paddingTop: '20px' }}
          iconType="square"
        />
        <Bar dataKey="attended" stackId="a" fill={colors.attended} name="Attended" radius={[8, 8, 0, 0]} />
        <Bar dataKey="unattended" stackId="a" fill={colors.unattended} name="Unattended" radius={[8, 8, 0, 0]} />
        <Bar dataKey="excused" stackId="a" fill={colors.excused} name="Excused" radius={[8, 8, 0, 0]} />
      </BarChart>
    </ResponsiveContainer>
  </div>

  <div class="mt-6 grid grid-cols-3 gap-4">
    <div class="bg-green-50 p-4 rounded-lg border border-green-200">
      <p class="text-xs text-gray-600 mb-1">Attended</p>
      <p class="text-lg font-bold text-green-600">
        {data.reduce((sum, item) => sum + item.attended, 0)}
      </p>
    </div>
    <div class="bg-red-50 p-4 rounded-lg border border-red-200">
      <p class="text-xs text-gray-600 mb-1">Unattended</p>
      <p class="text-lg font-bold text-red-600">
        {data.reduce((sum, item) => sum + item.unattended, 0)}
      </p>
    </div>
    <div class="bg-amber-50 p-4 rounded-lg border border-amber-200">
      <p class="text-xs text-gray-600 mb-1">Excused</p>
      <p class="text-lg font-bold text-amber-600">
        {data.reduce((sum, item) => sum + item.excused, 0)}
      </p>
    </div>
  </div>

  <div class="mt-4 p-4 bg-gray-50 rounded-lg border border-gray-200">
    <h3 class="font-semibold text-sm text-gray-900 mb-2">Legend</h3>
    <ul class="text-xs text-gray-600 space-y-1">
      <li><strong>Attended:</strong> Present at session</li>
      <li><strong>Unattended:</strong> Absent without explanation</li>
      <li><strong>Excused:</strong> Absent with valid reason (illness, official travel, etc.)</li>
    </ul>
  </div>
</div>

<style>
  :global(.recharts-tooltip) {
    outline: none;
  }

  :global(.recharts-default-tooltip) {
    background-color: white !important;
    border: 1px solid #e5e7eb !important;
    border-radius: 0.5rem !important;
  }
</style>
