---
interface Props {
  placeholder?: string;
}

const { placeholder = 'Buscar diputado...' } = Astro.props;
---

<div class="relative w-full">
  <input
    type="text"
    id="search-input"
    placeholder={placeholder}
    class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-brand-500 focus:border-transparent"
    onkeyup="handleSearch(this.value)"
    onblur="setTimeout(() => closeDropdown(), 200)"
  />

  <div
    id="search-dropdown"
    class="absolute top-full left-0 right-0 mt-1 bg-white border border-gray-300 rounded-lg shadow-lg max-h-64 overflow-y-auto hidden z-50"
  >
    <div id="search-results" class="divide-y divide-gray-200"></div>
    <div id="search-empty" class="p-4 text-center text-gray-500 text-sm hidden">
      No se encontraron resultados
    </div>
  </div>
</div>

<script>
  const API_URL = import.meta.env.API_URL || 'http://localhost:3000';
  let searchTimeout: NodeJS.Timeout;

  async function handleSearch(query: string) {
    const dropdown = document.getElementById('search-dropdown');
    const resultsDiv = document.getElementById('search-results');
    const emptyDiv = document.getElementById('search-empty');

    if (!query || query.length < 2) {
      dropdown?.classList.add('hidden');
      return;
    }

    clearTimeout(searchTimeout);

    searchTimeout = setTimeout(async () => {
      try {
        const res = await fetch(`${API_URL}/api/search?q=${encodeURIComponent(query)}&limit=10`);
        if (!res.ok) throw new Error('Search failed');

        const data = await res.json();
        const results = data.data || [];

        if (resultsDiv) {
          resultsDiv.innerHTML = '';
        }

        if (results.length === 0) {
          dropdown?.classList.remove('hidden');
          emptyDiv?.classList.remove('hidden');
        } else {
          emptyDiv?.classList.add('hidden');

          results.forEach(
            (politician: {
              id: number;
              name: string;
              partyId: number;
              position?: string;
            }) => {
              const item = document.createElement('a');
              item.href = `/politician/${politician.id}`;
              item.className =
                'block px-4 py-2 hover:bg-brand-50 cursor-pointer transition-colors';
              item.innerHTML = `
                <p class="font-medium text-gray-900">${politician.name}</p>
                <p class="text-xs text-gray-500">${politician.position || 'Diputado'}</p>
              `;
              resultsDiv?.appendChild(item);
            }
          );

          dropdown?.classList.remove('hidden');
        }
      } catch (error) {
        console.error('Search error:', error);
        if (resultsDiv) resultsDiv.innerHTML = '';
        emptyDiv?.classList.remove('hidden');
        dropdown?.classList.remove('hidden');
      }
    }, 300);
  }

  function closeDropdown() {
    const dropdown = document.getElementById('search-dropdown');
    dropdown?.classList.add('hidden');
  }

  // Expose functions to window
  (window as any).handleSearch = handleSearch;
  (window as any).closeDropdown = closeDropdown;
</script>
