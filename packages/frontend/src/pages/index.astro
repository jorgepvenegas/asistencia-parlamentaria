---
import DashboardLayout from '../layouts/DashboardLayout.astro';
import LandingPage from '../components/LandingPage';
import type { PoliticianAttendance, PartyAttendance } from '../types/dashboard';
import {
  politicianResponseSchema,
  partyResponseSchema,
  attendanceYearlyResponseSchema,
  partyAttendanceYearlyResponseSchema,
  type PoliticianResponse,
  type PartyResponse,
  type AttendanceYearlyResponse,
  type PartyAttendanceYearlyResponse,
} from '@quienatiende/shared/schemas';
import { z } from 'zod';

export function getStaticPaths() {
  return [
    { params: { year: '2025' } },
    { params: { year: '2024' } },
    { params: { year: '2023' } },
    { params: { year: '2022' } },
  ];
}

const year = Astro.params.year || '2025';
const yearNum = parseInt(year, 10);

const API_URL = import.meta.env.PUBLIC_BASE_URL_API || 'http://localhost:3000';

// Array schemas for validation
const politiciansArraySchema = z.array(politicianResponseSchema);
const partiesArraySchema = z.array(partyResponseSchema);
const attendanceArraySchema = z.array(attendanceYearlyResponseSchema);
const partyAttendanceArraySchema = z.array(partyAttendanceYearlyResponseSchema);

// Types from schemas
type ApiPolitician = PoliticianResponse;
type ApiParty = PartyResponse;
type ApiAttendance = AttendanceYearlyResponse;
type ApiPartyAttendance = PartyAttendanceYearlyResponse;

async function parseResponse<T>(
  res: Response,
  schema: z.ZodType<T>,
  label: string
): Promise<T | null> {
  if (!res.ok) return null;
  const { data } = await res.json();
  const result = schema.safeParse(data);
  if (result.success) return result.data;
  console.error(`${label} validation failed:`, result.error);
  return null;
}

let politicians: PoliticianAttendance[] = [];
let partyAttendance: PartyAttendance[] = [];
let error: string | null = null;

try {
  // Fetch all data in parallel
  const [politiciansRes, partiesRes, attendanceRes, partyAttendanceRes] = await Promise.all([
    fetch(`${API_URL}/api/politicians`),
    fetch(`${API_URL}/api/parties`),
    fetch(`${API_URL}/api/attendance/yearly?year=${yearNum}`),
    fetch(`${API_URL}/api/attendance/parties/yearly?year=${yearNum}`),
  ]);

  const politiciansData =
    (await parseResponse<ApiPolitician[]>(politiciansRes, politiciansArraySchema, 'Politicians')) ??
    [];
  const partiesData =
    (await parseResponse<ApiParty[]>(partiesRes, partiesArraySchema, 'Parties')) ?? [];
  const attendanceData =
    (await parseResponse<ApiAttendance[]>(attendanceRes, attendanceArraySchema, 'Attendance')) ??
    [];
  const partyAttendanceData =
    (await parseResponse<ApiPartyAttendance[]>(
      partyAttendanceRes,
      partyAttendanceArraySchema,
      'Party attendance'
    )) ?? [];

  // Create lookup maps
  const politicianMap = new Map(politiciansData.map((p) => [p.id, p]));
  const partyMap = new Map(partiesData.map((p) => [p.id, p]));

  // Transform data for Dashboard
  politicians = attendanceData
    .map((att) => {
      const politician = politicianMap.get(att.politicianId);
      if (!politician) return null;
      const party = partyMap.get(politician.partyId);

      // const totalSessions = att.attendanceCount + att.unjustifiedAbsentCount + att.

      const adjustedTotalSessions =
        att.attendanceCount + att.unjustifiedAbsentCount + att.absentCount;

      const avgAttendance = ((att.attendanceCount / adjustedTotalSessions) * 100).toFixed(2);
      const avgValidJust = ((att.justifiedAbsentCount / adjustedTotalSessions) * 100).toFixed(2);
      const avgInvalidJust = ((att.unjustifiedAbsentCount / adjustedTotalSessions) * 100).toFixed(
        2
      );
      const avgNoJust = ((att.absentCount / adjustedTotalSessions) * 100).toFixed(2);

      const val = {
        id: att.politicianId,
        name: politician.name,
        party: party?.name || 'Sin partido',
        partyId: politician.partyId,
        attendance: att.attendanceCount,
        avgAttendance: parseFloat(avgAttendance),
        validJust: att.justifiedAbsentCount,
        avgValidJust: parseFloat(avgValidJust),
        invalidJust: att.unjustifiedAbsentCount,
        avgInvalidJust: parseFloat(avgInvalidJust),
        noJust: att.absentCount,
        avgNoJust: parseFloat(avgNoJust),
        pct: parseFloat(att.attendanceAverage.toFixed(2)),
      } as PoliticianAttendance;

      return val;
    })
    .filter((p): p is PoliticianAttendance => p !== null);

  partyAttendance = partyAttendanceData.map((p) => {
    const adjustedTotalSessions = p.attendanceCount + p.unjustifiedAbsentCount + p.absentCount;

    return {
      ...p,
      avgAttendance: parseFloat(((p.attendanceCount / adjustedTotalSessions) * 100).toFixed(2)),
      avgValidJust: parseFloat(((p.justifiedAbsentCount / adjustedTotalSessions) * 100).toFixed(2)),
      avgInvalidJust: parseFloat(
        ((p.unjustifiedAbsentCount / adjustedTotalSessions) * 100).toFixed(2)
      ),
      avgNoJust: parseFloat(((p.absentCount / adjustedTotalSessions) * 100).toFixed(2)),
    };
  });
} catch (err) {
  error = 'Error connecting to server';
  console.error(err);
}
---

<DashboardLayout
  title="QuienAtiende - Asistencia Parlamentaria"
  description="Transparencia sobre la asistencia de diputados a sesiones parlamentarias"
>
  {
    error ? (
      <div
        style={{
          minHeight: '100vh',
          background: '#0f0f1a',
          color: '#e0e0e0',
          display: 'flex',
          alignItems: 'center',
          justifyContent: 'center',
          fontFamily: "'Source Sans 3', sans-serif",
        }}
      >
        <div
          style={{
            background: '#16162a',
            borderRadius: 16,
            padding: 32,
            border: '1px solid rgba(255,255,255,0.06)',
            textAlign: 'center',
          }}
        >
          <p style={{ color: '#E63946', fontWeight: 600, marginBottom: 8 }}>
            Error al cargar datos
          </p>
          <p style={{ color: '#777' }}>{error}</p>
        </div>
      </div>
    ) : politicians.length === 0 ? (
      <div
        style={{
          minHeight: '100vh',
          background: '#0f0f1a',
          color: '#e0e0e0',
          display: 'flex',
          alignItems: 'center',
          justifyContent: 'center',
          fontFamily: "'Source Sans 3', sans-serif",
        }}
      >
        <div
          style={{
            background: '#16162a',
            borderRadius: 16,
            padding: 32,
            border: '1px solid rgba(255,255,255,0.06)',
            textAlign: 'center',
          }}
        >
          <p style={{ color: '#F4A261', fontWeight: 600 }}>No hay datos disponibles</p>
          <p style={{ color: '#777' }}>Verifica que el servidor API esté ejecutándose.</p>
        </div>
      </div>
    ) : (
      <LandingPage
        client:load
        politicians={politicians}
        partyAttendance={partyAttendance}
        initialYear={yearNum}
      />
    )
  }
</DashboardLayout>
