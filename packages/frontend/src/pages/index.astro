---
import DashboardLayout from '../layouts/DashboardLayout.astro';
import Dashboard from '../components/Dashboard';
import type { PoliticianAttendance, PartyData, PartyAttendance } from '../types/dashboard';

export function getStaticPaths() {
  return [
    { params: { year: '2025' } },
    { params: { year: '2024' } },
    { params: { year: '2023' } },
    { params: { year: '2022' } },
  ];
}

const year = Astro.params.year || '2025';
console.log('year', year);
const yearNum = parseInt(year, 10);

const API_URL = import.meta.env.API_URL || 'http://localhost:3000';

interface ApiPolitician {
  id: number;
  name: string;
  partyId: number;
}

interface ApiParty {
  id: number;
  name: string;
  slug: string;
  color: string;
  abbreviation?: string;
}

interface ApiAttendance {
  politicianId: number;
  year: number;
  attendanceCount: number;
  absentCount: number;
  justifiedAbsentCount: number;
  unjustifiedAbsentCount: number;
  attendanceAverage: number;
}

interface ApiPartyAttendance {
  partyId: number;
  partyName: string;
  year: number;
  attendanceCount: number;
  absentCount: number;
  justifiedAbsentCount: number;
  unjustifiedAbsentCount: number;
  attendanceAverage: number;
}

let politicians: PoliticianAttendance[] = [];
let partyAttendance: PartyAttendance[] = [];
let parties: PartyData[] = [];
let years: number[] = [2025, 2024, 2023, 2022];
let error: string | null = null;

try {
  // Fetch all data in parallel
  const [politiciansRes, partiesRes, attendanceRes, partyAttendanceRes] = await Promise.all([
    fetch(`${API_URL}/api/politicians`),
    fetch(`${API_URL}/api/parties`),
    fetch(`${API_URL}/api/attendance/yearly?year=${yearNum}`),
    fetch(`${API_URL}/api/attendance/parties/yearly?year=${yearNum}`),
  ]);

  let apiPoliticians: ApiPolitician[] = [];
  let apiParties: ApiParty[] = [];
  let apiAttendance: ApiAttendance[] = [];
  let apiPartyAttendance: ApiPartyAttendance[] = [];

  if (politiciansRes.ok) {
    const data = await politiciansRes.json();
    apiPoliticians = data.data || [];
  }

  if (partiesRes.ok) {
    const data = await partiesRes.json();
    apiParties = data.data || [];
  }

  if (attendanceRes.ok) {
    const data = await attendanceRes.json();
    apiAttendance = data.data || [];
  }

  if (partyAttendanceRes.ok) {
    const data = await partyAttendanceRes.json();
    apiPartyAttendance = data.data || [];
  }

  // Create lookup maps
  const politicianMap = new Map(apiPoliticians.map((p) => [p.id, p]));
  const partyMap = new Map(apiParties.map((p) => [p.id, p]));

  // Transform data for Dashboard
  politicians = apiAttendance
    .map((att) => {
      const pol = politicianMap.get(att.politicianId);
      if (!pol) return null;
      const party = partyMap.get(pol.partyId);

      const totalDays = att.attendanceCount + att.justifiedAbsentCount + att.unjustifiedAbsentCount;
      const noJust = att.absentCount - att.justifiedAbsentCount;

      return {
        id: att.politicianId,
        name: pol.name,
        party: party?.name || 'Sin partido',
        partyId: pol.partyId,
        attendance: att.attendanceCount,
        validJust: att.justifiedAbsentCount,
        invalidJust: att.unjustifiedAbsentCount,
        noJust: Math.max(0, noJust),
        pct: parseFloat(att.attendanceAverage.toFixed(2)),
      } as PoliticianAttendance;
    })
    .filter((p): p is PoliticianAttendance => p !== null);

  // Transform parties
  parties = apiParties.map((p) => ({
    id: p.id,
    name: p.name,
    slug: p.slug,
    color: p.color,
    abbreviation: p.abbreviation,
  }));

  // Transform party attendance
  partyAttendance = apiPartyAttendance;
} catch (err) {
  error = 'Error connecting to server';
  console.error(err);
}
---

<DashboardLayout
  title="QuienAtiende - Asistencia Parlamentaria"
  description="Transparencia sobre la asistencia de diputados a sesiones parlamentarias"
>
  {
    error ? (
      <div
        style={{
          minHeight: '100vh',
          background: '#0f0f1a',
          color: '#e0e0e0',
          display: 'flex',
          alignItems: 'center',
          justifyContent: 'center',
          fontFamily: "'Source Sans 3', sans-serif",
        }}
      >
        <div
          style={{
            background: '#16162a',
            borderRadius: 16,
            padding: 32,
            border: '1px solid rgba(255,255,255,0.06)',
            textAlign: 'center',
          }}
        >
          <p style={{ color: '#E63946', fontWeight: 600, marginBottom: 8 }}>
            Error al cargar datos
          </p>
          <p style={{ color: '#777' }}>{error}</p>
        </div>
      </div>
    ) : politicians.length === 0 ? (
      <div
        style={{
          minHeight: '100vh',
          background: '#0f0f1a',
          color: '#e0e0e0',
          display: 'flex',
          alignItems: 'center',
          justifyContent: 'center',
          fontFamily: "'Source Sans 3', sans-serif",
        }}
      >
        <div
          style={{
            background: '#16162a',
            borderRadius: 16,
            padding: 32,
            border: '1px solid rgba(255,255,255,0.06)',
            textAlign: 'center',
          }}
        >
          <p style={{ color: '#F4A261', fontWeight: 600 }}>No hay datos disponibles</p>
          <p style={{ color: '#777' }}>Verifica que el servidor API esté ejecutándose.</p>
        </div>
      </div>
    ) : (
      <Dashboard
        client:load
        politicians={politicians}
        partyAttendance={partyAttendance}
        parties={parties}
        years={years}
        initialYear={yearNum}
      />
    )
  }
</DashboardLayout>
