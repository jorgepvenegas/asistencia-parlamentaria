---
import BaseLayout from '../../layouts/BaseLayout.astro';

const API_URL = import.meta.env.API_URL || 'http://localhost:3000';
const { id } = Astro.params;

if (!id) {
  return Astro.redirect('/');
}

interface AttendanceRecord {
  date: string;
  status: 'attended' | 'unattended' | 'excused';
  reason?: string;
}

interface Politician {
  id: string;
  name: string;
  party_id: string;
  position?: string;
  district?: string;
}

interface Party {
  id: string;
  name: string;
  color: string;
}

let politician: Politician | null = null;
let party: Party | null = null;
let attendanceRecords: AttendanceRecord[] = [];
let error: string | null = null;
let summaryByMonth: Record<string, { attended: number; unattended: number; excused: number }> = {};

try {
  // Fetch politician detail
  const politicianRes = await fetch(`${API_URL}/api/politicians/${id}`);
  if (!politicianRes.ok) {
    error = 'Politician not found';
  } else {
    const data = await politicianRes.json();
    politician = data.data;

    if (politician) {
      // Fetch party info
      const partiesRes = await fetch(`${API_URL}/api/parties`);
      if (partiesRes.ok) {
        const partiesData = await partiesRes.json();
        const parties = partiesData.data || [];
        party = parties.find((p: Party) => p.id === politician?.party_id) || null;
      }

      // Fetch 2026 attendance records
      const attendanceRes = await fetch(`${API_URL}/api/politicians/${id}/attendance?year=2026`);
      if (attendanceRes.ok) {
        const attendanceData = await attendanceRes.json();
        attendanceRecords = (attendanceData.data || []).sort(
          (a: AttendanceRecord, b: AttendanceRecord) =>
            new Date(b.date).getTime() - new Date(a.date).getTime()
        );

        // Summarize by month
        const monthSummary: Record<string, { attended: number; unattended: number; excused: number }> = {};
        for (const record of attendanceRecords) {
          const date = new Date(record.date);
          const monthKey = `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}`;

          if (!monthSummary[monthKey]) {
            monthSummary[monthKey] = { attended: 0, unattended: 0, excused: 0 };
          }

          if (record.status === 'attended') monthSummary[monthKey].attended++;
          else if (record.status === 'unattended') monthSummary[monthKey].unattended++;
          else if (record.status === 'excused') monthSummary[monthKey].excused++;
        }

        summaryByMonth = monthSummary;
      }
    }
  }
} catch (err) {
  error = 'Error loading politician data';
  console.error(err);
}

// Calculate overall stats
const totalSessions = attendanceRecords.length;
const attendedCount = attendanceRecords.filter((r) => r.status === 'attended').length;
const unattendedCount = attendanceRecords.filter((r) => r.status === 'unattended').length;
const excusedCount = attendanceRecords.filter((r) => r.status === 'excused').length;
const attendancePercentage = totalSessions > 0 ? (attendedCount / totalSessions) * 100 : 0;

// Get unique absence reasons
const reasons = new Map<string, number>();
attendanceRecords
  .filter((r) => r.status === 'excused' && r.reason)
  .forEach((r) => {
    reasons.set(r.reason!, (reasons.get(r.reason!) || 0) + 1);
  });

const sortedReasons = Array.from(reasons.entries())
  .sort((a, b) => b[1] - a[1])
  .slice(0, 5);

// Month name mapping
const monthNameEs = [
  '', 'Enero', 'Febrero', 'Marzo', 'Abril', 'Mayo', 'Junio',
  'Julio', 'Agosto', 'Septiembre', 'Octubre', 'Noviembre', 'Diciembre'
];
---

<BaseLayout title={politician ? `${politician.name} - Perfil` : 'Perfil de Diputado'}>
  <div class="space-y-8">
    <!-- Back Button -->
    <div class="flex items-center gap-2">
      <a href="/" class="text-brand-600 hover:text-brand-700 font-medium">← Volver</a>
    </div>

    {error && (
      <div class="bg-red-50 border border-red-200 rounded-lg p-4 text-red-800">
        <p class="font-semibold">Error</p>
        <p class="text-sm">{error}</p>
      </div>
    )}

    {politician && (
      <>
        <!-- Header -->
        <section class="bg-white rounded-lg border border-gray-200 p-6" style={party ? `border-left: 6px solid ${party.color}` : ''}>
          <div class="flex items-start justify-between">
            <div>
              <h1 class="text-4xl font-bold text-gray-900 mb-2">{politician.name}</h1>
              <div class="space-y-1 text-gray-600">
                {party && <p class="text-lg font-medium" style={`color: ${party.color}`}>{party.name}</p>}
                {politician.position && <p>{politician.position}</p>}
                {politician.district && <p>{politician.district}</p>}
              </div>
            </div>
            <div class="text-right">
              <p class="text-5xl font-bold text-gray-900">{attendancePercentage.toFixed(1)}%</p>
              <p class="text-gray-600 text-sm mt-1">Asistencia total</p>
            </div>
          </div>
        </section>

        <!-- Statistics Cards -->
        <section class="grid grid-cols-1 md:grid-cols-4 gap-4">
          <div class="bg-gradient-to-br from-green-50 to-green-100 rounded-lg p-4 border border-green-200">
            <p class="text-sm text-green-700 font-medium mb-1">Sesiones asistidas</p>
            <p class="text-3xl font-bold text-green-900">{attendedCount}</p>
          </div>
          <div class="bg-gradient-to-br from-red-50 to-red-100 rounded-lg p-4 border border-red-200">
            <p class="text-sm text-red-700 font-medium mb-1">Ausencias</p>
            <p class="text-3xl font-bold text-red-900">{unattendedCount}</p>
          </div>
          <div class="bg-gradient-to-br from-amber-50 to-amber-100 rounded-lg p-4 border border-amber-200">
            <p class="text-sm text-amber-700 font-medium mb-1">Justificadas</p>
            <p class="text-3xl font-bold text-amber-900">{excusedCount}</p>
          </div>
          <div class="bg-gradient-to-br from-blue-50 to-blue-100 rounded-lg p-4 border border-blue-200">
            <p class="text-sm text-blue-700 font-medium mb-1">Total de sesiones</p>
            <p class="text-3xl font-bold text-blue-900">{totalSessions}</p>
          </div>
        </section>

        <!-- Absence Reasons -->
        {sortedReasons.length > 0 && (
          <section class="bg-white rounded-lg border border-gray-200 p-6">
            <h2 class="text-xl font-bold text-gray-900 mb-4">Razones principales de ausencia</h2>
            <div class="space-y-3">
              {sortedReasons.map(([reason, count]) => (
                <div class="flex items-center justify-between p-3 bg-gray-50 rounded-lg">
                  <span class="text-gray-700">{reason}</span>
                  <span class="bg-amber-100 text-amber-800 px-3 py-1 rounded-full text-sm font-medium">
                    {count} vez{count !== 1 ? 'es' : ''}
                  </span>
                </div>
              ))}
            </div>
          </section>
        )}

        <!-- Monthly Breakdown -->
        {Object.keys(summaryByMonth).length > 0 && (
          <section class="bg-white rounded-lg border border-gray-200 p-6">
            <h2 class="text-xl font-bold text-gray-900 mb-4">Desglose mensual 2026</h2>
            <div class="space-y-3">
              {Object.entries(summaryByMonth)
                .sort()
                .reverse()
                .map(([month, stats]) => {
                  const [year, monthNum] = month.split('-');
                  const monthNum_ = parseInt(monthNum, 10);
                  const total = stats.attended + stats.unattended + stats.excused;
                  const monthPercentage = total > 0 ? (stats.attended / total) * 100 : 0;

                  return (
                    <div class="flex items-center justify-between p-4 bg-gray-50 rounded-lg hover:bg-gray-100 transition-colors">
                      <div>
                        <p class="font-medium text-gray-900">
                          {monthNameEs[monthNum_]} {year}
                        </p>
                        <p class="text-xs text-gray-600">
                          {stats.attended} presente, {stats.unattended} ausente, {stats.excused} justificado
                        </p>
                      </div>
                      <span class="text-lg font-bold text-gray-900">{monthPercentage.toFixed(0)}%</span>
                    </div>
                  );
                })}
            </div>
          </section>
        )}

        <!-- Recent Attendance -->
        <section class="bg-white rounded-lg border border-gray-200 p-6">
          <h2 class="text-xl font-bold text-gray-900 mb-4">Historial reciente</h2>
          {attendanceRecords.length > 0 ? (
            <div class="space-y-2 max-h-96 overflow-y-auto">
              {attendanceRecords.slice(0, 30).map((record) => {
                const date = new Date(record.date);
                const dateStr = date.toLocaleDateString('es-CR', {
                  weekday: 'short',
                  year: 'numeric',
                  month: '2-digit',
                  day: '2-digit',
                });

                const statusColor = {
                  attended: 'bg-green-100 text-green-800 border-green-300',
                  unattended: 'bg-red-100 text-red-800 border-red-300',
                  excused: 'bg-amber-100 text-amber-800 border-amber-300',
                }[record.status];

                return (
                  <div class="flex items-center justify-between p-3 bg-gray-50 rounded-lg">
                    <div>
                      <p class="font-mono text-sm text-gray-600">{dateStr}</p>
                      {record.reason && (
                        <p class="text-xs text-gray-500 mt-1">Razón: {record.reason}</p>
                      )}
                    </div>
                    <span class={`inline-block px-3 py-1 rounded-full text-sm font-medium border ${statusColor}`}>
                      {record.status === 'attended' && 'Presente'}
                      {record.status === 'unattended' && 'Ausente'}
                      {record.status === 'excused' && 'Justificado'}
                    </span>
                  </div>
                );
              })}
            </div>
          ) : (
            <p class="text-gray-500 text-center py-4">No hay registros de asistencia disponibles.</p>
          )}
        </section>
      </>
    )}
  </div>
</BaseLayout>
