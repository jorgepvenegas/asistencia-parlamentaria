openapi: 3.1.0
info:
  title: QuienAtiende API
  version: 1.0.0
  description: Public transparency API for politician attendance data
  contact:
    name: QuienAtiende Team
  license:
    name: MIT

servers:
  - url: http://localhost:3000/api
    description: Development server
  - url: https://api.quienatiende.example.com/api
    description: Production server

tags:
  - name: Politicians
    description: Politician/official data and profiles
  - name: Attendance
    description: Attendance records and summaries
  - name: Parties
    description: Political party information
  - name: Search
    description: Search and discovery endpoints
  - name: Metadata
    description: System metadata

paths:
  /politicians:
    get:
      tags:
        - Politicians
      summary: List all politicians with yearly summary
      description: Returns all active politicians with their yearly attendance percentage for a specified year
      parameters:
        - name: year
          in: query
          required: true
          schema:
            type: integer
            example: 2025
          description: Year to retrieve attendance data for
        - name: party_id
          in: query
          required: false
          schema:
            type: string
            example: PARTY_001
          description: Filter by political party ID
        - name: sort
          in: query
          required: false
          schema:
            type: string
            enum: [attendance_desc, attendance_asc, name_asc, name_desc]
            default: attendance_desc
          description: Sort order for results
        - name: limit
          in: query
          required: false
          schema:
            type: integer
            default: 100
            minimum: 1
            maximum: 500
          description: Limit results count
        - name: offset
          in: query
          required: false
          schema:
            type: integer
            default: 0
            minimum: 0
          description: Offset for pagination
      responses:
        '200':
          description: Successful response
          content:
            application/json:
              schema:
                type: object
                properties:
                  data:
                    type: array
                    items:
                      $ref: '#/components/schemas/PoliticianSummary'
                  pagination:
                    $ref: '#/components/schemas/Pagination'
                  metadata:
                    $ref: '#/components/schemas/ResponseMetadata'
        '400':
          $ref: '#/components/responses/BadRequest'
        '500':
          $ref: '#/components/responses/ServerError'

  /politicians/{id}:
    get:
      tags:
        - Politicians
      summary: Get individual politician profile
      description: Returns detailed information about a specific politician including all attendance records
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
            example: POL001
          description: Politician ID
      responses:
        '200':
          description: Successful response
          content:
            application/json:
              schema:
                type: object
                properties:
                  data:
                    $ref: '#/components/schemas/PoliticianDetail'
                  metadata:
                    $ref: '#/components/schemas/ResponseMetadata'
        '404':
          $ref: '#/components/responses/NotFound'
        '500':
          $ref: '#/components/responses/ServerError'

  /politicians/{id}/attendance:
    get:
      tags:
        - Attendance
      summary: Get politician attendance records
      description: Returns attendance records for a specific politician, optionally filtered by year and month
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
            example: POL001
          description: Politician ID
        - name: year
          in: query
          required: true
          schema:
            type: integer
            example: 2026
          description: Year to retrieve records for
        - name: month
          in: query
          required: false
          schema:
            type: integer
            minimum: 1
            maximum: 12
            example: 3
          description: Optional month filter (1-12)
      responses:
        '200':
          description: Successful response
          content:
            application/json:
              schema:
                type: object
                properties:
                  data:
                    type: array
                    items:
                      $ref: '#/components/schemas/AttendanceRecord'
                  summary:
                    $ref: '#/components/schemas/AttendanceSummary'
                  metadata:
                    $ref: '#/components/schemas/ResponseMetadata'
        '400':
          $ref: '#/components/responses/BadRequest'
        '404':
          $ref: '#/components/responses/NotFound'
        '500':
          $ref: '#/components/responses/ServerError'

  /search:
    get:
      tags:
        - Search
      summary: Search politicians by name
      description: Returns autocomplete suggestions for politician names, useful for search functionality
      parameters:
        - name: q
          in: query
          required: true
          schema:
            type: string
            minLength: 1
            maxLength: 100
            example: "Mar√≠a"
          description: Search query (politician name or partial name)
        - name: limit
          in: query
          required: false
          schema:
            type: integer
            default: 10
            minimum: 1
            maximum: 50
          description: Maximum results to return
      responses:
        '200':
          description: Search results
          content:
            application/json:
              schema:
                type: object
                properties:
                  data:
                    type: array
                    items:
                      type: object
                      properties:
                        id:
                          type: string
                        name:
                          type: string
                        party_id:
                          type: string
                        party_name:
                          type: string
                        position:
                          type: string
                  metadata:
                    $ref: '#/components/schemas/ResponseMetadata'
        '400':
          $ref: '#/components/responses/BadRequest'
        '500':
          $ref: '#/components/responses/ServerError'

  /parties:
    get:
      tags:
        - Parties
      summary: List all political parties
      description: Returns list of all political parties with their associated information (name, color for charts, etc.)
      responses:
        '200':
          description: Successful response
          content:
            application/json:
              schema:
                type: object
                properties:
                  data:
                    type: array
                    items:
                      $ref: '#/components/schemas/Party'
                  metadata:
                    $ref: '#/components/schemas/ResponseMetadata'
        '500':
          $ref: '#/components/responses/ServerError'

  /attendance/summary:
    get:
      tags:
        - Attendance
      summary: Get aggregated attendance summary
      description: Returns aggregate attendance statistics, optionally filtered by year and political parties
      parameters:
        - name: year
          in: query
          required: true
          schema:
            type: integer
            example: 2025
          description: Year to retrieve data for
        - name: parties
          in: query
          required: false
          schema:
            type: string
            example: "PARTY_001,PARTY_002"
          description: Comma-separated list of party IDs to filter by. If empty, returns all parties.
        - name: month
          in: query
          required: false
          schema:
            type: integer
            minimum: 1
            maximum: 12
            example: 3
          description: Optional month filter (1-12). If provided, returns month-specific data.
      responses:
        '200':
          description: Successful response
          content:
            application/json:
              schema:
                type: object
                properties:
                  data:
                    type: object
                    properties:
                      by_party:
                        type: array
                        items:
                          type: object
                          properties:
                            party_id:
                              type: string
                            party_name:
                              type: string
                            politician_count:
                              type: integer
                            average_attendance_percent:
                              type: number
                              format: float
                            politicians:
                              type: array
                              items:
                                type: object
                                properties:
                                  id:
                                    type: string
                                  name:
                                    type: string
                                  attendance_percent:
                                    type: number
                                    format: float
                      overall:
                        type: object
                        properties:
                          total_sessions:
                            type: integer
                          total_attended:
                            type: integer
                          total_unattended:
                            type: integer
                          total_excused:
                            type: integer
                          average_attendance_percent:
                            type: number
                            format: float
                  metadata:
                    $ref: '#/components/schemas/ResponseMetadata'
        '400':
          $ref: '#/components/responses/BadRequest'
        '500':
          $ref: '#/components/responses/ServerError'

  /metadata:
    get:
      tags:
        - Metadata
      summary: Get system metadata
      description: Returns system-level metadata including data source, last update timestamp, and schema version
      responses:
        '200':
          description: Successful response
          content:
            application/json:
              schema:
                type: object
                properties:
                  data:
                    type: object
                    properties:
                      last_update:
                        type: string
                        format: date-time
                        description: ISO 8601 timestamp of last data update
                        example: "2026-01-27T10:00:00Z"
                      data_source:
                        type: string
                        description: Source of attendance data
                        example: "parliament.example.com"
                      schema_version:
                        type: string
                        example: "1.0.0"
                      available_years:
                        type: array
                        items:
                          type: integer
                        example: [2024, 2025, 2026]
                  metadata:
                    $ref: '#/components/schemas/ResponseMetadata'
        '500':
          $ref: '#/components/responses/ServerError'

components:
  schemas:
    Politician:
      type: object
      required:
        - id
        - name
        - party_id
      properties:
        id:
          type: string
          description: Unique politician identifier
        name:
          type: string
          description: Full name
        party_id:
          type: string
          description: Political party ID
        party_name:
          type: string
          description: Political party name
        position:
          type: string
          nullable: true
          description: Official position/title
        district:
          type: string
          nullable: true
          description: Geographical area represented
        photo_url:
          type: string
          nullable: true
          description: Profile photo URL

    PoliticianSummary:
      allOf:
        - $ref: '#/components/schemas/Politician'
        - type: object
          properties:
            attendance_percent:
              type: number
              format: float
              description: Yearly attendance percentage (0-100)
              example: 85.5

    PoliticianDetail:
      allOf:
        - $ref: '#/components/schemas/PoliticianSummary'
        - type: object
          properties:
            yearly_summaries:
              type: array
              items:
                type: object
                properties:
                  year:
                    type: integer
                  attendance_percent:
                    type: number
                  attendance_count:
                    type: integer
            recent_attendance:
              type: array
              items:
                $ref: '#/components/schemas/AttendanceRecord'

    AttendanceRecord:
      type: object
      required:
        - id
        - politician_id
        - date
        - status
      properties:
        id:
          type: string
          description: Unique attendance record ID
        politician_id:
          type: string
        date:
          type: string
          format: date
          description: Date of session
          example: "2026-03-15"
        session_type:
          type: string
          nullable: true
          description: Type of session (Plenary, Committee, etc.)
        status:
          type: string
          enum: [attended, unattended, excused]
          description: Attendance status
        reason:
          type: string
          nullable: true
          description: Reason for absence (if applicable)
          maxLength: 500

    AttendanceSummary:
      type: object
      required:
        - politician_id
        - year
        - total_sessions
        - attended_count
        - unattended_count
        - excused_count
        - percentage_attended
      properties:
        politician_id:
          type: string
        year:
          type: integer
        month:
          type: integer
          nullable: true
          description: Month (1-12) or null for yearly summary
        total_sessions:
          type: integer
          description: Total expected sessions
        attended_count:
          type: integer
        unattended_count:
          type: integer
        excused_count:
          type: integer
        percentage_attended:
          type: number
          format: float
          description: Percentage of sessions attended (0-100)

    Party:
      type: object
      required:
        - id
        - name
        - slug
        - color
      properties:
        id:
          type: string
        name:
          type: string
          description: Full party name
        slug:
          type: string
          description: URL-friendly identifier
        color:
          type: string
          format: hex-color
          description: Hex color code for charts (e.g., #FF0000)
        abbreviation:
          type: string
          nullable: true
          description: Short party abbreviation

    Pagination:
      type: object
      properties:
        limit:
          type: integer
        offset:
          type: integer
        total:
          type: integer
          description: Total number of results available
        hasMore:
          type: boolean

    ResponseMetadata:
      type: object
      properties:
        timestamp:
          type: string
          format: date-time
          description: When response was generated
        version:
          type: string
          description: API version
        dataLastUpdate:
          type: string
          format: date-time
          description: Timestamp of last data update

    Error:
      type: object
      required:
        - error
        - statusCode
      properties:
        error:
          type: string
          description: Error message (user-friendly)
        statusCode:
          type: integer
        details:
          type: object
          description: Additional error details (validation errors, etc.)

  responses:
    BadRequest:
      description: Bad request (invalid parameters)
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/Error'

    NotFound:
      description: Resource not found
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/Error'

    ServerError:
      description: Server error
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/Error'

  securitySchemes: {}

security: []
